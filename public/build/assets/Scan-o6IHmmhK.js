import{u as G,B as V,_ as H,a as J,b as K,M as W}from"./useCooldown-Bu_2v7Sc.js";import{d,i as X,j as Z,e as c,o as n,a as t,f as E,c as N,g as C,t as z,n as U,k as ee,l as A,b as te,m as R}from"./app-BNo7mkZ5.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={class:"min-h-screen p-6",style:{"background-color":"var(--bg-body)",color:"var(--text-color)"}},oe={key:0,class:"mb-6 max-w-md mx-auto"},re={class:"flex items-center"},le={key:0,class:"w-5 h-5 mr-3 text-red-500",fill:"currentColor",viewBox:"0 0 20 20"},se={key:1,class:"w-5 h-5 mr-3 text-green-500",fill:"currentColor",viewBox:"0 0 20 20"},ne={class:"font-medium"},ie={class:"grid grid-cols-1 xl:grid-cols-2 gap-8 max-w-7xl mx-auto"},de={class:"space-y-6"},ce={class:"text-center"},ue={class:"flex items-center justify-center"},ve={class:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 20 20"},ge={key:0,"fill-rule":"evenodd",d:"M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2h-1.586l-.707-.707A1 1 0 0013 2H7a1 1 0 00-.707.293L5.586 3H4zm6 9a3 3 0 100-6 3 3 0 000 6z","clip-rule":"evenodd"},me={key:1,"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v3.586l1.293-1.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L8 10.586V7z","clip-rule":"evenodd"},pe={class:"rounded-2xl shadow-xl p-6",style:{"background-color":"var(--bg-panel)",color:"var(--text-color)"}},be={class:"relative mx-auto bg-gray-900 rounded-xl overflow-hidden",style:{width:"500px",height:"400px"}},fe={class:"absolute top-4 right-4 flex items-center space-x-2 bg-black bg-opacity-50 rounded-full px-3 py-1"},xe={class:"text-white text-sm font-medium"},he={key:0,class:"flex justify-center items-center"},we={key:0,class:"rounded-2xl shadow-xl p-6",style:{"background-color":"var(--bg-card)",color:"var(--text-color)"}},ye={key:1,class:"rounded-2xl shadow-xl p-6",style:{"background-color":"var(--bg-card)",color:"var(--text-color)"}},ze={__name:"Scan",setup(Ee){const _="http://localhost",{mostrarAlertaEntradaExitosa:Q,puedeMarcarAsistencia:D}=K(),{bloquearEscaneoTemporal:I,puedeEjecutar:j,limpiarTimers:q}=G(5e3),F=d(null),a=d(null),o=d("bg-blue-100 text-blue-800"),v=d(!1),L=d([]),g=d(!1),m=d(null),p=d(!1),b=d("estudiante"),x=d(null);let h=null,f=null,k=null;const M=r=>{a.value=`QR procesado. Espera ${r} segundos para escanear otro...`,o.value="bg-yellow-100 text-yellow-800"},S=()=>{x&&(a.value="ACEPTADO",Q(),o.value="bg-green-100 text-green-800")},w=()=>{g.value=!g.value};function O(){window.location.href=`${_}/dashboard`}const P=async r=>{try{if(r.includes("/qr/")&&(b.value="externo"),p.value=!0,b.value==="estudiante"){if(!D()){p.value=!1;return}const e=await fetch(`${_}/scrap-estudiante?url=${r}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Error al hacer scraping en el servidor");const l=await e.json();m.value=l;const s=l&&Object.keys(l).length>0&&!l.error;if(m.value=s?l:{},!s){a.value="Documento no válido",o.value="bg-red-100 text-red-800";return}console.log(l);const i={descripcion:"Estudiante aceptado",fecha:new Date().toISOString().split("T")[0],hora:new Date().toTimeString().split(" ")[0],user_id:parseInt(l.REGISTRO),tipoalerta_id:1};R.post(route("entrada.store"),i).then(u=>{a.value=u.data.message,x=!0,o.value="bg-green-100 text-green-800"}).catch(u=>{var y,$;a.value=(($=(y=u.response)==null?void 0:y.data)==null?void 0:$.message)||"Error al registrar entrada",x=!1,o.value="bg-red-100 text-red-800"}).finally(()=>{p.value=!1})}else{if(!D()){p.value=!1;return}const e=r.split("/"),l=e[e.length-1],s=await R.get(`${_}/qr/${l}`);if(console.log("Datos del usuario:",s.data),!s.data.success)throw new Error("Error al obtener datos del usuario");m.value=s.data.user,console.log("Role:",b.value);const i=await R.post(`${_}/qr/entrada`,{user_id:s.data.user.id,tipo:"entrada",descripcion:"Entrada vía QR - Usuario externo"});i.data.success?(x.value=!0,a.value=i.data.mensaje,o.value="bg-green-100 text-green-800"):(a.value=i.data.mensaje||"Error al registrar entrada Consultar con el administrador",x=!1)}}catch(e){console.error("Error al extraer datos:",e),a.value=`Error: ${e.message||"No se pudieron extraer los datos"}`,o.value="bg-red-100 text-red-800"}finally{p.value=!1}},T=async()=>{try{a.value="Inicializando cámara con zoom 200%...",o.value="bg-blue-100 text-blue-800",h||(h=new V);const r=document.getElementById("qr-preview"),e={video:{width:{ideal:1920},height:{ideal:1080},advanced:[{zoom:3}],focusMode:"continuous"}};await h.decodeFromConstraints(e,r,(l,s)=>{if(l&&j()){const i=l.getText();try{const u=new URL(i);F.value=u.href,a.value="QR leído correctamente. Extrayendo datos...",o.value="bg-blue-100 text-blue-800",I(M,S),P(u.href)}catch{a.value="El contenido del QR no es una URL válida: "+i,o.value="bg-yellow-100 text-yellow-800",I(M,S)}}else l&&!j()&&console.log("QR detectado pero en período de cooldown");s&&!(s instanceof TypeError)&&console.error("Error de escaneo:",s)}),v.value=!0;try{const s=r.srcObject.getVideoTracks()[0];if(s){const i=s.getCapabilities();if(i.zoom){const u=Math.min(i.zoom.max,2);await s.applyConstraints({advanced:[{zoom:u}]}),a.value=`Cámara activada con zoom ${Math.round(u*100)}%`,o.value="bg-green-100 text-green-800",f&&clearInterval(f),f=setInterval(()=>{const y=s.getSettings();y.zoom&&(a.value=`Cámara activa con zoom ${Math.round(y.zoom*100)}%`)},5e3)}else a.value="Cámara activada (zoom digital aplicado visualmente)",o.value="bg-green-100 text-green-800"}}catch(l){console.warn("No se pudo aplicar configuración avanzada de zoom:",l)}}catch(r){console.error("Error al inicializar la cámara:",r),a.value=`Error: ${r.message||"No se pudo iniciar la cámara"}`,o.value="bg-red-100 text-red-800",v.value=!1}},B=()=>{h&&(h.reset(),v.value=!1,f&&(clearInterval(f),f=null),a.value="Cámara pausada",o.value="bg-yellow-100 text-yellow-800")},Y=()=>{v.value?B():T()};return X(async()=>{a.value="Buscando cámaras disponibles...",o.value="bg-blue-100 text-blue-800";try{const r=await V.listVideoInputDevices();if(L.value=r,r.length===0){a.value="No se encontró ninguna cámara",o.value="bg-red-100 text-red-800";return}await T()}catch(r){console.error("Error al enumerar dispositivos:",r),a.value=`Error: ${r.message||"No se pudo enumerar las cámaras"}`,o.value="bg-red-100 text-red-800"}k=setInterval(()=>{w()},4e3)}),Z(()=>{B(),k&&(clearInterval(k),k=null),q()}),(r,e)=>(n(),c("div",ae,[t("div",{class:"mb-4"},[t("button",{onClick:O,class:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"},e[0]||(e[0]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor","stroke-width":"2",viewBox:"0 0 24 24"},[t("path",{d:"M15 19l-7-7 7-7","stroke-linecap":"round","stroke-linejoin":"round"})],-1),C(" Atrás ")]))]),e[9]||(e[9]=t("div",{class:"text-center mb-8"},[t("h1",{class:"text-4xl font-bold bg-gradient-to-r from-blue-800 to-red-600 bg-clip-text text-transparent mb-2"}," Sistema de Identificación Universitaria "),t("p",{class:"text-lg font-medium",style:{color:"var(--text-muted)"}},"Escáner de Código QR - Carnet Digital UAGRM "),t("div",{class:"w-24 h-1 bg-gradient-to-r from-blue-600 to-red-600 mx-auto mt-3 rounded-full"})],-1)),a.value?(n(),c("div",oe,[t("div",{class:U(["p-4 rounded-lg shadow-lg border-l-4",o.value]),style:{"background-color":"var(--alert-bg)",color:"var(--alert-text)","border-color":"var(--alert-border)"}},[t("div",re,[a.value.includes("Error")?(n(),c("svg",le,e[1]||(e[1]=[t("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"},null,-1)]))):(n(),c("svg",se,e[2]||(e[2]=[t("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"},null,-1)]))),t("span",ne,z(a.value),1)])],2)])):E("",!0),t("div",ie,[t("div",de,[t("div",ce,[t("button",{onClick:Y,class:U(["px-8 py-3 rounded-xl font-semibold text-white shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-xl",v.value?"bg-gradient-to-r from-red-500 to-red-600":"bg-gradient-to-r from-blue-500 to-blue-600"])},[t("span",ue,[(n(),c("svg",ve,[v.value?(n(),c("path",me)):(n(),c("path",ge))])),C(" "+z(v.value?"Pausar Cámara":"Activar Cámara"),1)])],2)]),e[6]||(e[6]=C(" + ")),t("div",pe,[e[5]||(e[5]=t("h3",{class:"text-xl font-bold mb-4 text-center",style:{color:"var(--text-color)"}},"Vista del Escáner ",-1)),t("div",be,[e[4]||(e[4]=ee('<video id="qr-preview" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-xl" style="min-width:100%;min-height:100%;object-fit:cover;" autoplay muted></video><div class="absolute inset-0 pointer-events-none flex items-center justify-center"><div class="relative w-48 h-48"><div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-green-400 rounded-tl-lg"></div><div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-green-400 rounded-tr-lg"></div><div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-green-400 rounded-bl-lg"></div><div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-green-400 rounded-br-lg"></div><div class="absolute inset-x-0 top-1/2 h-0.5 bg-gradient-to-r from-transparent via-green-400 to-transparent animate-pulse"></div></div></div>',2)),t("div",fe,[e[3]||(e[3]=t("div",{class:"w-2 h-2 bg-green-400 rounded-full animate-pulse"},null,-1)),t("span",xe,z(v.value?"Escaneando...":"Inactivo"),1)])])])]),m.value?(n(),c("div",he,[b.value==="estudiante"?(n(),c("div",we,[e[7]||(e[7]=t("h3",{class:"text-xl font-bold mb-6 text-center",style:{color:"var(--text-color)"}},"Carnet Universitario Digital",-1)),t("div",{class:"relative w-96 h-64 transition-all duration-700 ease-in-out cursor-pointer",style:A({transformStyle:"preserve-3d",transform:g.value?"rotateY(180deg)":"rotateY(0deg)"}),onClick:w},[b.value==="estudiante"?(n(),N(H,{key:0,estudianteData:m.value,flipped:g.value,onToggleFlip:w},null,8,["estudianteData","flipped"])):E("",!0)],4)])):E("",!0)])):b.value==="externo"?(n(),c("div",ye,[e[8]||(e[8]=t("h3",{class:"text-xl font-bold mb-6 text-center",style:{color:"var(--text-color)"}}," Carnet de Usuario ",-1)),t("div",{class:"relative w-96 h-64 transition-all duration-700 ease-in-out cursor-pointer",style:A({transformStyle:"preserve-3d",transform:g.value?"rotateY(180deg)":"rotateY(0deg)"}),onClick:w},[te(J,{estudianteData:m.value,flipped:g.value,onToggleFlip:w},null,8,["estudianteData","flipped"])],4)])):E("",!0)]),p.value?(n(),N(W,{key:1})):E("",!0)]))}};export{ze as default};
